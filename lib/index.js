"use strict";
/**
 * Created by user on 2019/4/30.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const findYarnWorkspaceRoot = require("find-yarn-workspace-root2");
const pkgDir = require("pkg-dir");
const path = require("upath2");
const fs = require("fs-extra");
const debug_color2_1 = require("debug-color2");
const util_1 = require("debug-color2/lib/util");
const package_dts_1 = require("@ts-type/package-dts");
exports.console = new debug_color2_1.Console2();
exports.consoleDebug = new debug_color2_1.Console2(null, {
    label: true,
    time: true,
});
function pathNormalize(input) {
    return path.normalize(input);
}
exports.pathNormalize = pathNormalize;
function pathEqual(a, b) {
    return path.normalize(a) === path.normalize(b);
}
exports.pathEqual = pathEqual;
function findRoot(options, throwError) {
    if (!options.cwd) {
        throw new TypeError(`options.cwd is '${options.cwd}'`);
    }
    let ws;
    if (!options.skipCheckWorkspace) {
        ws = findYarnWorkspaceRoot(options.cwd);
    }
    let pkg = pkgDir.sync(options.cwd);
    if (pkg == null && (options.throwError || (options.throwError == null && throwError))) {
        let err = new TypeError(`can't found package root from target directory '${options.cwd}'`);
        throw err;
    }
    let hasWorkspace = ws && ws != null;
    let isWorkspace = hasWorkspace && pathEqual(ws, pkg);
    let root = hasWorkspace ? ws : pkg;
    return {
        pkg,
        ws,
        hasWorkspace,
        isWorkspace,
        root,
    };
}
exports.findRoot = findRoot;
function fsYarnLock(root) {
    let yarnlock_file = path.join(root, 'yarn.lock');
    let yarnlock_exists = fs.existsSync(yarnlock_file);
    let yarnlock_old = yarnlock_exists && fs.readFileSync(yarnlock_file, 'utf8') || null;
    return {
        yarnlock_file,
        yarnlock_exists,
        yarnlock_old,
    };
}
exports.fsYarnLock = fsYarnLock;
function lazyFlags(keys, argv) {
    return keys.map(key => argv[key] && '--' + key);
}
exports.lazyFlags = lazyFlags;
exports.chalkByConsole = util_1.createFnChalkByConsole(exports.console);
function printRootData(rootData, argv) {
    let doWorkspace = !rootData.isWorkspace && rootData.hasWorkspace;
    let pkg_file = path.join(rootData.pkg, 'package.json');
    let pkg_data = package_dts_1.readPackageJson(pkg_file);
    exports.consoleDebug.info(`${pkg_data.name}@${pkg_data.version}`, path.relative(doWorkspace ? rootData.ws : argv.cwd, rootData.pkg));
}
exports.printRootData = printRootData;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsbUVBQW9FO0FBQ3BFLGtDQUFtQztBQUNuQywrQkFBZ0M7QUFDaEMsK0JBQWdDO0FBQ2hDLCtDQUF3QztBQUN4QyxnREFBK0Q7QUFDL0Qsc0RBQXVEO0FBSTFDLFFBQUEsT0FBTyxHQUFHLElBQUksdUJBQVEsRUFBRSxDQUFDO0FBRXpCLFFBQUEsWUFBWSxHQUFHLElBQUksdUJBQVEsQ0FBQyxJQUFJLEVBQUU7SUFDOUMsS0FBSyxFQUFFLElBQUk7SUFDWCxJQUFJLEVBQUUsSUFBSTtDQUNWLENBQUMsQ0FBQztBQUVILFNBQWdCLGFBQWEsQ0FBQyxLQUFhO0lBRTFDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUM3QixDQUFDO0FBSEQsc0NBR0M7QUFFRCxTQUFnQixTQUFTLENBQUMsQ0FBUyxFQUFFLENBQVM7SUFFN0MsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDL0MsQ0FBQztBQUhELDhCQUdDO0FBRUQsU0FBZ0IsUUFBUSxDQUFDLE9BSXhCLEVBQUUsVUFBb0I7SUFFdEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQ2hCO1FBQ0MsTUFBTSxJQUFJLFNBQVMsQ0FBQyxtQkFBbUIsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUE7S0FDdEQ7SUFFRCxJQUFJLEVBQVUsQ0FBQztJQUVmLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEVBQy9CO1FBQ0MsRUFBRSxHQUFHLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUN4QztJQUVELElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRW5DLElBQUksR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLElBQUksSUFBSSxVQUFVLENBQUMsQ0FBQyxFQUNyRjtRQUNDLElBQUksR0FBRyxHQUFHLElBQUksU0FBUyxDQUFDLG1EQUFtRCxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUMzRixNQUFNLEdBQUcsQ0FBQztLQUNWO0lBRUQsSUFBSSxZQUFZLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUM7SUFDcEMsSUFBSSxXQUFXLEdBQUcsWUFBWSxJQUFJLFNBQVMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDckQsSUFBSSxJQUFJLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztJQUVuQyxPQUFPO1FBQ04sR0FBRztRQUNILEVBQUU7UUFDRixZQUFZO1FBQ1osV0FBVztRQUNYLElBQUk7S0FDSixDQUFBO0FBQ0YsQ0FBQztBQXJDRCw0QkFxQ0M7QUFFRCxTQUFnQixVQUFVLENBQUMsSUFBWTtJQUV0QyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztJQUVqRCxJQUFJLGVBQWUsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRW5ELElBQUksWUFBWSxHQUFHLGVBQWUsSUFBSSxFQUFFLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUM7SUFFckYsT0FBTztRQUNOLGFBQWE7UUFDYixlQUFlO1FBQ2YsWUFBWTtLQUNaLENBQUE7QUFDRixDQUFDO0FBYkQsZ0NBYUM7QUFFRCxTQUFnQixTQUFTLENBQUMsSUFBYyxFQUFFLElBRXpDO0lBRUEsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQTtBQUNoRCxDQUFDO0FBTEQsOEJBS0M7QUFFWSxRQUFBLGNBQWMsR0FBRyw2QkFBc0IsQ0FBQyxlQUFPLENBQUMsQ0FBQztBQUU5RCxTQUFnQixhQUFhLENBQUMsUUFBcUMsRUFBRSxJQUFtQztJQUV2RyxJQUFJLFdBQVcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxXQUFXLElBQUksUUFBUSxDQUFDLFlBQVksQ0FBQztJQUVqRSxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDdkQsSUFBSSxRQUFRLEdBQUcsNkJBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUV6QyxvQkFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLElBQUksUUFBUSxDQUFDLE9BQU8sRUFBRSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQzlILENBQUM7QUFSRCxzQ0FRQztBQUVELGtCQUFlLE9BQW1DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE5LzQvMzAuXG4gKi9cblxuaW1wb3J0IGZpbmRZYXJuV29ya3NwYWNlUm9vdCA9IHJlcXVpcmUoJ2ZpbmQteWFybi13b3Jrc3BhY2Utcm9vdDInKTtcbmltcG9ydCBwa2dEaXIgPSByZXF1aXJlKCdwa2ctZGlyJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3VwYXRoMicpO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmltcG9ydCB7IENvbnNvbGUyIH0gZnJvbSAnZGVidWctY29sb3IyJztcbmltcG9ydCB7IGNyZWF0ZUZuQ2hhbGtCeUNvbnNvbGUgfSBmcm9tICdkZWJ1Zy1jb2xvcjIvbGliL3V0aWwnO1xuaW1wb3J0IHsgcmVhZFBhY2thZ2VKc29uIH0gZnJvbSAnQHRzLXR5cGUvcGFja2FnZS1kdHMnO1xuaW1wb3J0IHsgQXJndW1lbnRzIH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IHsgSVVucGFja015WWFyZ3NBcmd2IH0gZnJvbSAnLi9jbWRfZGlyJztcblxuZXhwb3J0IGNvbnN0IGNvbnNvbGUgPSBuZXcgQ29uc29sZTIoKTtcblxuZXhwb3J0IGNvbnN0IGNvbnNvbGVEZWJ1ZyA9IG5ldyBDb25zb2xlMihudWxsLCB7XG5cdGxhYmVsOiB0cnVlLFxuXHR0aW1lOiB0cnVlLFxufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXRoTm9ybWFsaXplKGlucHV0OiBzdHJpbmcpXG57XG5cdHJldHVybiBwYXRoLm5vcm1hbGl6ZShpbnB1dClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhdGhFcXVhbChhOiBzdHJpbmcsIGI6IHN0cmluZylcbntcblx0cmV0dXJuIHBhdGgubm9ybWFsaXplKGEpID09PSBwYXRoLm5vcm1hbGl6ZShiKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZFJvb3Qob3B0aW9uczoge1xuXHRjd2Q6IHN0cmluZyxcblx0c2tpcENoZWNrV29ya3NwYWNlPzogYm9vbGVhbiB8IHN0cmluZyxcblx0dGhyb3dFcnJvcj86IGJvb2xlYW4sXG59LCB0aHJvd0Vycm9yPzogYm9vbGVhbilcbntcblx0aWYgKCFvcHRpb25zLmN3ZClcblx0e1xuXHRcdHRocm93IG5ldyBUeXBlRXJyb3IoYG9wdGlvbnMuY3dkIGlzICcke29wdGlvbnMuY3dkfSdgKVxuXHR9XG5cblx0bGV0IHdzOiBzdHJpbmc7XG5cblx0aWYgKCFvcHRpb25zLnNraXBDaGVja1dvcmtzcGFjZSlcblx0e1xuXHRcdHdzID0gZmluZFlhcm5Xb3Jrc3BhY2VSb290KG9wdGlvbnMuY3dkKTtcblx0fVxuXG5cdGxldCBwa2cgPSBwa2dEaXIuc3luYyhvcHRpb25zLmN3ZCk7XG5cblx0aWYgKHBrZyA9PSBudWxsICYmIChvcHRpb25zLnRocm93RXJyb3IgfHwgKG9wdGlvbnMudGhyb3dFcnJvciA9PSBudWxsICYmIHRocm93RXJyb3IpKSlcblx0e1xuXHRcdGxldCBlcnIgPSBuZXcgVHlwZUVycm9yKGBjYW4ndCBmb3VuZCBwYWNrYWdlIHJvb3QgZnJvbSB0YXJnZXQgZGlyZWN0b3J5ICcke29wdGlvbnMuY3dkfSdgKTtcblx0XHR0aHJvdyBlcnI7XG5cdH1cblxuXHRsZXQgaGFzV29ya3NwYWNlID0gd3MgJiYgd3MgIT0gbnVsbDtcblx0bGV0IGlzV29ya3NwYWNlID0gaGFzV29ya3NwYWNlICYmIHBhdGhFcXVhbCh3cywgcGtnKTtcblx0bGV0IHJvb3QgPSBoYXNXb3Jrc3BhY2UgPyB3cyA6IHBrZztcblxuXHRyZXR1cm4ge1xuXHRcdHBrZyxcblx0XHR3cyxcblx0XHRoYXNXb3Jrc3BhY2UsXG5cdFx0aXNXb3Jrc3BhY2UsXG5cdFx0cm9vdCxcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZnNZYXJuTG9jayhyb290OiBzdHJpbmcpXG57XG5cdGxldCB5YXJubG9ja19maWxlID0gcGF0aC5qb2luKHJvb3QsICd5YXJuLmxvY2snKTtcblxuXHRsZXQgeWFybmxvY2tfZXhpc3RzID0gZnMuZXhpc3RzU3luYyh5YXJubG9ja19maWxlKTtcblxuXHRsZXQgeWFybmxvY2tfb2xkID0geWFybmxvY2tfZXhpc3RzICYmIGZzLnJlYWRGaWxlU3luYyh5YXJubG9ja19maWxlLCAndXRmOCcpIHx8IG51bGw7XG5cblx0cmV0dXJuIHtcblx0XHR5YXJubG9ja19maWxlLFxuXHRcdHlhcm5sb2NrX2V4aXN0cyxcblx0XHR5YXJubG9ja19vbGQsXG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxhenlGbGFncyhrZXlzOiBzdHJpbmdbXSwgYXJndjoge1xuXHRbazogc3RyaW5nXTogYm9vbGVhbixcbn0pXG57XG5cdHJldHVybiBrZXlzLm1hcChrZXkgPT4gYXJndltrZXldICYmICctLScgKyBrZXkpXG59XG5cbmV4cG9ydCBjb25zdCBjaGFsa0J5Q29uc29sZSA9IGNyZWF0ZUZuQ2hhbGtCeUNvbnNvbGUoY29uc29sZSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmludFJvb3REYXRhKHJvb3REYXRhOiBSZXR1cm5UeXBlPHR5cGVvZiBmaW5kUm9vdD4sIGFyZ3Y6IEFyZ3VtZW50czxJVW5wYWNrTXlZYXJnc0FyZ3Y+KVxue1xuXHRsZXQgZG9Xb3Jrc3BhY2UgPSAhcm9vdERhdGEuaXNXb3Jrc3BhY2UgJiYgcm9vdERhdGEuaGFzV29ya3NwYWNlO1xuXG5cdGxldCBwa2dfZmlsZSA9IHBhdGguam9pbihyb290RGF0YS5wa2csICdwYWNrYWdlLmpzb24nKTtcblx0bGV0IHBrZ19kYXRhID0gcmVhZFBhY2thZ2VKc29uKHBrZ19maWxlKTtcblxuXHRjb25zb2xlRGVidWcuaW5mbyhgJHtwa2dfZGF0YS5uYW1lfUAke3BrZ19kYXRhLnZlcnNpb259YCwgcGF0aC5yZWxhdGl2ZShkb1dvcmtzcGFjZSA/IHJvb3REYXRhLndzIDogYXJndi5jd2QsIHJvb3REYXRhLnBrZykpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBleHBvcnRzIGFzIHR5cGVvZiBpbXBvcnQoJy4vaW5kZXgnKTtcbiJdfQ==